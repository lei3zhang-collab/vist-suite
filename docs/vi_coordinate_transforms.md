**视觉-惯性 坐标系变换笔记**

- **概述**: 记录 `IMU` 与相机光学坐标系之间的映射、IMU 姿态的存储与插值、以及将 IMU 旋转增量映射到相机系后对锁定点进行重投影的完整流程。

**坐标系定义**
- IMU (Body): x 向右，y 向前，z 向上。
- Camera (Optical): x 向右，y 向下，z 向前。
- IMU -> Camera 固定旋转（绕 X 轴 +90°）:
$$
R_{i2c}=\begin{bmatrix}
1 & 0 & 0\\
0 & 0 & -1\\
0 & 1 & 0
\end{bmatrix}
$$

**四元数到旋转矩阵**
给定四元数 $q=(x,y,z,w)$（注意按消息字段顺序），可构造旋转矩阵：
$$
R(q)=\begin{bmatrix}
1-2y^2-2z^2 & 2xy-2zw & 2xz+2yw\\
2xy+2zw & 1-2x^2-2z^2 & 2yz-2xw\\
2xz-2yw & 2yz+2xw & 1-2x^2-2y^2
\end{bmatrix}
$$
（实现时应先确保四元数归一化以减少数值误差）

**时间同步与缓存**
- 将 IMU 姿态以 $(t_{ns}, R)$ 形式存入循环缓冲（示例中保留最近 2s 数据）。
- 使用二分查找 (`bisect`) 在时间戳数组中定位图像时间点，示例采用最近邻（Nearest‑Neighbor）插值来选择最接近的 IMU 姿态。

**相对旋转量计算（IMU 基座）**
- 锁定时保存基准姿态 $R_{start}$，当前时刻读取 $R_{current}$。
- 相对旋转（在 IMU 表示下）为：
$$
R_{\Delta}^{imu}=R_{start}^T R_{current}
$$

**从 IMU 基座到相机基座（相似变换）**
- 将 IMU 的相对旋转变换到相机坐标系：
$$
R_{\Delta}^{cam}=R_{i2c}\,R_{\Delta}^{imu}\,R_{i2c}^T
$$
- 这是标准的基底变换（相似变换），用于把同一旋转在不同坐标系下表示出来。

**点随相机运动的更新（反向旋转）**
- 空间点在世界中静止，摄像机运动导致点在相机系中做“反向旋转”。因此用旋转的逆（等于转置）来更新点坐标：
$$
p_{now}=(R_{\Delta}^{cam})^T p_{start}
$$
- 代码中直接使用 $p_{start}$ 为以相机坐标表示的锁定点。

**反投影 / 重投影**
- 反投影（像素 -> 相机坐标）：
$$
p = Z K^{-1} \begin{bmatrix}u\\ v\\ 1\end{bmatrix}
$$
- 代码中以深度（毫米）与相机内参 `K_ir` 直接计算：
$$
x = (u - c_x) Z / f_x,\quad y=(v - c_y) Z / f_y,\quad z=Z
$$
- 重投影（相机坐标 -> 像素）：
$$
u = f_x \frac{x}{z} + c_x,\quad v = f_y \frac{y}{z} + c_y
$$
- 注意对 $z$ 做下界保护（示例中用 `tz > 0.1`）以避免除零或异常大投影。

**单位与实现近似**
- 示例代码中深度以 **毫米** 为单位（保持内参与深度单位一致很重要）。
- 实现中忽略了相机-IMU 间的平移分量（只考虑旋转），在存在显著平移或近距离场景时需加入平移补偿。
- IMU 插值采用最近邻，低延迟但在高速角动或低采样率下可能造成误差，必要时可使用四元数球面插值（Slerp）或旋转矩阵插值策略。

**注意事项 / 验证要点**
- 验证 `R_{i2c}` 是否与实际硬件定义一致（不同设备轴定义可能不同）。
- 确保消息时间基准一致（IMU 与相机时间是否同步或是否存在恒定时间偏移）。
- 在集成测试中记录若干帧的 $R_{start}, R_{current}, R_{\Delta}^{cam}$ 与重投影像素，目视验证标记是否稳定。

---

